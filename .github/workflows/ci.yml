name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    name: Backend –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏ –±–µ–∫–µ–Ω–¥—É
        working-directory: ./backend
        run: |
          pip install pytest pytest-asyncio
          pytest ../tests -q

  frontend-tests:
    name: Frontend –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install http-server locally
        run: npm install http-server

      - name: –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
        run: |
          npx http-server frontend -p 8001 &

      - name: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å index.html
        run: |
          sleep 2
          curl -f http://localhost:8001/index.html

  docker-build:
    name: Docker –±—ñ–ª–¥
    runs-on: ubuntu-latest
    needs: frontend-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t test-image -f backend/Dockerfile .

      - name: Run Docker container and test
        run: |
          docker run -d -p 8000:8000 --name test_container test-image
          echo "‚è≥ –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          sleep 5
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:"
          curl -f http://localhost:8000 || (echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î" && docker logs test_container && exit 1)
          echo "‚úÖ –°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î! –ó—É–ø–∏–Ω—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä."
          docker stop test_container
